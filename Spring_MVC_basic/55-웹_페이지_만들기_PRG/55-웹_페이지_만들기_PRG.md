# 웹 페이지 만들기 - PRG(Post/Redirect/Get)

## 상품 등록 처리 컨트롤러의 문제점
사실 현재 개발해 둔 상품 등록 처리 컨트롤러(`addItemVer1` ~ `addItemVer4`)에는 심각한 문제가 있다. 상품 등록을 완료하고 웹 브라우저의 새로고침 버튼을 클릭하면 상품이 계속해서 중복 등록되는 것을 확인할 수 있다.

##### 상품 등록 흐름
![](스크린샷%202022-06-15%20오후%2010.49.17.png)

##### POST 요청으로 등록 후 새로 고침
![](스크린샷%202022-06-15%20오후%2010.50.13.png)
- 웹 브라우저의 새로 고침은 마지막에 서버에 전송한 데이터를 다시 전송한다.
- 상품 등록 폼에서 데이터를 입력하고 저장 버튼을 누르면, 입력한 상품 데이터가 담긴 `POST /add` 요청이 서버로 전송한다.
- 이 상태에서 새로 고침을 또 선택하면 마지막에 전송한 `POST /add` 요청이 서버로 다시 전송하게 된다.
- 그래서 상품 정보는 동일하고 ID만 다른 상품이 계속 등록된다.


## 상품 등록 처리 컨트롤러 문제 해결
### PRG(Post/Redirect/Get) 적용
##### PRG 흐름도
![](스크린샷%202022-06-15%20오후%2010.53.10.png)
- 웹 브라우저의 새로 고침은 마지막에 서버에 전송한 데이터를 다시 전송한다.
- 새로 고침에 의한 `POST /add` 요청이 반복되는 문제를 해결하려면. 상품 저장 후에 뷰 템플릿을 호출하는 것이 아니라, 상품 상세 정보 화면으로 리다이렉트를 해주면 된다.
- 웹 브라우저는 리다이렉트를 통해 상품 저장 후에 실제 상품 상세 화면으로 새로운 요청을 보낸다.
- 따라서 웹 브라우저가 마지막에 보낸 요청이 상품 상세 화면에 대한 요청인 `GET /items/{id}` 가 되는 것이다.
- 따라서 이후 새로고침을 해도 상품 상세 화면에 대한 요청을 반복하게 되므로 새로 고침 문제를 해결할 수 있다.
- **이 방식을 PRG 라고 한다.**

##### addItemVer5 - BasicItemController.java 일부
```Java
@PostMapping("/add")
public String addItemVer5(Item item) {
	itemRepository.save(item);
	return "redirect:/basic/items/" + item.getId();
}
```

#### 주의
`"redirect:/basic/items/" + item.getId()` 처럼 URL에 변수를 더해서 사용하는 것은 URL 인코딩이 안되기 때문에 위험하다. 위 코드에서는 단순히 long 변수를 더하는 것이기 때문에 문제가 없지만, 변수에 한글이나 띄어쓰기 같은 값이 들어가 있으면 URL 인코딩이 반드시 필요하다. 따라서 다음 장에 설명하는 `RedirectAttributes` 를 사용하는 것이 좋다.